name: master

on:
  push:
    branches: [ master ]

jobs:
  build_test_windows:
    name: Run build and test [Windows]
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8'
      - name: Run test
        run: |
          dotnet test test/

  build_test_mac:
    name: Run build and test [macOS]
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8'
      - name: Run test
        run: |
          dotnet test test/

  build_test_linux:
    name: Run build and test [Linux]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8'
      - name: Run test
        run: |
          dotnet test test/

  publish_nuget:
    name: Publish NuGet package
    runs-on: ubuntu-latest
    needs: [build_test_mac, build_test_linux, build_test_windows]

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Calculate version
        id: version
        run: |
          # Read major version from VERSION file
          MAJOR_VERSION=$(cat VERSION)
          
          # Get the latest tag matching the major version pattern
          LATEST_TAG=$(git tag -l "${MAJOR_VERSION}.*.*" --sort=-v:refname | head -n 1)
          
          if [ -z "$LATEST_TAG" ]; then
            # No existing tags for this major version, start with MAJOR.0.0
            MINOR_VERSION=0
          else
            # Extract minor version from latest tag and increment
            MINOR_VERSION=$(echo $LATEST_TAG | cut -d. -f2)
            MINOR_VERSION=$((MINOR_VERSION + 1))
          fi
          
          # Build full version string
          APP_VERSION="${MAJOR_VERSION}.${MINOR_VERSION}.0"
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "Calculated version: $APP_VERSION"

      - name: Create and push tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "${{ env.APP_VERSION }}" -m "Release ${{ env.APP_VERSION }}"
          git push origin "${{ env.APP_VERSION }}"

      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8'

      - name: Publish NuGet package
        shell: pwsh
        run: |
          $env:NugetApiKey = "${{ secrets.NUGET_API_KEY }}"
          ls
          ./pack.ps1 ${{ env.APP_VERSION }}